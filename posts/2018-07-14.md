# 嵌入式系统C语言程序开发-变量、宏、结构体和函数的声明、定义与调用

在开发嵌入式系统的程序时，**如何在众多的头文件和源文件中定义大量的变量、宏、结构体和函数，使程序结构清晰、形式规范，便于阅读和维护**，是许多初学者遇到的问题。我初步总结了一些规范和技巧，供大家参考。虽然下文以编写TMS320F28335控制程序为例进行说明，但是我想这些规范也同样适用于其他嵌入式芯片的程序编写工作。  

本文中所说的全局变量、全局结构体和全局函数指的是能够在不同源程序的函数中进行调用的变量、结构体和函数，其他的都可以称作局部变量，也就是只能够在某一个源程序的函数中进行调用的变量、结构体和函数（*注意：此处的局部变量指的是可以由同一个源文件中的各个函数调用的变量，而C语言中的局部变量指的是只能在一个函数内部使用的变量*）。  

对于本文所说的局部变量、局部结构体和局部函数，只要在使用它们的源文件中进行声明和定义就可以了，下面主要说明全局变量、全局结构体、全局函数和宏的声明、定义和调用方法。  

## 1 全局变量的声明和定义

**定义**：在源文件`DSP2833x_GlobalVariableDefs.c`文件中，如：  

`float		variable_a	=0.0;`  

**声明**：在头文件`DSP2833x_GlobalVariable.h`中，如：  

`extern float variable_a;`  

**调用**：在其他源文件中调用时，先包含头文件`DSP2833x_GlobalVariable.h`（程序语句为`#include "DSP2833x_GlobalVariableh"`），然后就可以对变量`variable_a`进行操作了。  

**注意**：`DSP2833x_GlobalVariable.h`被包含在了`DSP2833x_Device.h`中：  

`#include "DSP2833x_GlobalVariable.h"`  

所以在其他源文件（.c文件）中只要把头文件`DSP2833x_Device.h`包含进去（如`#include "DSP2833x_Device.h"`），就相当于声明了`extern volatile float CapVol`;其余所有全局变量都可以这样操作。  

## 2 宏

宏的定义一般在头文件``DSP2833x_GlobalVariable.h``中进行，如：  

`#define	pi	3.14159265359`  

**声明**：无需声明  

**调用**：在所有源文件中可直接调用pi。  

## 3 全局结构体变量的声明和定义

**定义**：在头文件`a.h`中定义结构体变量的**成员**（*注意不是定义结构体变量*），在`b.c`中定义结构体变量；  

**声明**：在`a.h`中声明在`b.c`中定义的结构体变量为外部变量；  

**调用**：包含结构体`a.h`（`#include "a.h"`）后可对结构体变量进行操作。  

如：
在`a.h`中，  
```C 
struct PID {float m; int16 n;};
extern PID x,y,z;
```  
在`b.c`中，
```C
struct PID x,y,z;
```
在`c.c`中，
```C
#include a.h
x.m=2.5;
y.n=25;
```

**注意**：  

1. 在DSP28335编程中，`a.h`选择头文件`DSP2833x_GlobalVariable.h`，`b.c`选择源文件`DSP2833x_GlobalVariableDefs.c`，当然也可以在用到该结构体变量的源文件中定义，这里参考TI编程风格，方便统一管理变量；  

2. 结构体成员一定要在头文件中定义，若在源文件中定义，则其他的源文件不知道结构体成员，无法对结构体成员进行操作，如：  

在`a.h`中，
```C 
extern PID x,y,z;
```
在`b.c`中，
```C
struct PID {float m; int16 n;};
struct PID x,y,z;
```
在`c.c`中，
```C
#include a.h
x.m=2.5;//调用结构体成员时会报错
y.n=25; //调用结构体成员时会报错
```
3. 结构体变量一定要在源文件中定义，若在头文件中，则当多个源文件包含该头文件时会出现重复定义的错误，如：  

在`a.h`中，
```C 
struct PID {float m; int16 n;};
struct PID x,y,z;
extern PID x,y,z;
```
在`b.c`中，
```C
#include a.h	//重复定义
```
在`c.c`中，
```C
#include a.h	//重复定义
```

## 4 全局函数的声明与定义

**定义**：在源文件中声明函数，并定义，声明和定义可以分开也可以在一起；  

**声明**：在头文件中声明函数为外部函数，加extern关键字；  

**调用**：包含该头文件后即可调用函数。  

**注意**：在头文件中声明函数为外部函数时可以不加关键字`extern`，因为在头文件里声明的函数默认为带有`extern`属性，这和变量不一样，若是在头文件中不加`extern`声明变量，则在多个源文件中包含该头文件时会导致重复定义。  

原因在于函数的声明和定义的形式是不一样的，定义函数要有函数体，而声明函数没有函数体，且以分号结尾，所以外部函数声明时可以将`extern`省略掉，而其他文件也知道这个函数是在其他地方定义的，不加`extern`关键字也可以区分开函数的声明和定义。  

另一方面，变量若是不加`extern`而直接声明，如`int a;`，其实这相当于定义了一个变量，在编译时会为其分配存储空间，若在在多个源文件中包含该头文件就会导致重复定义的错误发生。

